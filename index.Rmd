---
title: "Spatial distribution of the Vegetation transects for the Colonization Pattern experiment (*Q. pyrenaica*)"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: yeti
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library('flexdashboard')
library('rgdal')
library("leaflet") 
library("sp")
library("sf")
library("raster")
library("dplyr")
library("here")
library("mapview")
library("maptools")
```


```{r readData}
# Read spatial data 
qp <- rgdal::readOGR(dsn='/Users/ajpelu/Google Drive/_phd/_geoinfo/dist_SN/',
                     layer = 'q_pyr_sn_4326', verbose = FALSE, encoding = "UTF-8")

crops <- rgdal::readOGR(dsn=here::here("data/dist_cultivos/"),
                     layer = 'aux_ajpelu_cultivos_56', verbose = FALSE, encoding = "UTF-8")

crops <- spTransform(crops, CRS("+init=epsg:4326")) 
crops@data <- crops@data %>% mutate(
  crop = case_when(
         loc == "CANAR" & cultivo == "CULT_1" ~ "CA1",
         loc == "CANAR" & cultivo == "CULT_2" ~ "CA2",
         loc == "CANAR" & cultivo == "CULT_3" ~ "CA3",
         loc == "SANJUAN" & cultivo == "CULT_1" ~ "SJ1",
         loc == "SANJUAN" & cultivo == "CULT_2" ~ "SJ2"))


transectos_raw <- rgdal::readOGR(dsn='/Users/ajpelu/Google Drive/_phd/_geoinfo/migrame/',
                     layer = 'mig_transectos', verbose = FALSE, encoding = "UTF-8")
transectos_raw <- spTransform(transectos_raw, CRS("+init=epsg:4326")) 
transectos <- subset(transectos_raw, tipo %in% c('CLARO', 'CLARO_BORDE','ROBLEDAL')) 

transectos@data <- transectos@data %>% mutate(
  cropname = case_when(
         localidad == "CANAR" & subtipo == "CLARO1" ~ "CA1",
         localidad == "CANAR" & subtipo == "CLARO2" ~ "CA2",
         localidad == "CANAR" & subtipo == "CLARO3" ~ "CA3",
         localidad == "SANJUAN" & subtipo == "CL1" ~ "SJ1",
         localidad == "SANJUAN" & subtipo == "CL2" ~ "SJ2"),
  type = case_when(
    tipo == "CLARO" ~ "Cropland",
    tipo == "CLARO_BORDE" ~ "Edge",
    tipo == "ROBLEDAL" ~ "Forests"
  ))
  

```


```{r optionsMap}
popup_crops<- paste0("<strong>Loc:</strong> ", crops$loc,
                   "<br><strong>Crop Code:</strong> ", crops$crop,
                   "<br><strong>Area (ha):</strong> ", round(crops$shape_area/10000, 2))

pal <- colorFactor(
  palette = c('blue', 'red', 'green'),
  domain = transectos$tipo
)

popup_transectos <- paste0("<strong>Loc:</strong> ", transectos$localidad,
                           "<br><strong>Type:</strong> ", transectos$type,
                           "<br><strong>Code:</strong> ", transectos$nombre,
                           "<br><strong>Elevation:</strong> ", transectos$altitud,
                   "<br><strong>Crop Code:</strong> ", transectos$cropname)
```


```{r baseMap}
map_base <- leaflet() %>%
  addWMSTiles('http://www.ign.es/wms/pnoa-historico', 
              layers = 'AMS_1956-1957',
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Americano 1956"
              ) %>% 
  addWMSTiles('http://www.ign.es/wms/pnoa-historico', 
              layers = 'Nacional_1981-1986',
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Vuelo Nacional (1981-1986)"
              ) %>% 
  addWMSTiles('http://www.ign.es/wms/pnoa-historico', 
              layers = 'Interministerial_1973-1986',
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "Vuelo Interministerial (1973-1986)"
              ) %>%
  addWMSTiles('http://www.ign.es/wms/pnoa-historico', 
              layers = 'OLISTAT',
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              group = "OLISTAT (1997-1998)"
              ) %>%
  addWMSTiles('http://www.ideandalucia.es/wms/mdt_2005?',
              layers = 'Sombreado_10',
              options = WMSTileOptions(format = "image/png", transparent = TRUE),
              attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>', 
              group = 'Hillshade') %>% 
  addTiles(urlTemplate = "http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
           attribution = '<a href="https://carto.com/attributions">CARTO</a>',
           group = 'Basemap') %>%

  addWMSTiles('http://www.ideandalucia.es/services/toporaster10/wms?',
              layers = 'toporaster10',
              options = WMSTileOptions(format = "image/png", transparent = FALSE),
              attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>',
              group = 'Topographical') %>%
  addWMSTiles('http://www.ideandalucia.es/wms/mta10r_2001-2013?',
              layers = 'mta10r_2001-2013',
              options = WMSTileOptions(format = "image/png", transparent = FALSE),
              attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>',
              group = 'topo2013') %>% 
  
    addWMSTiles('http://www.ideandalucia.es/wms/mta10v_2007?',
              layers = 'mta10v_2007',
              options = WMSTileOptions(format = "image/png", transparent = FALSE),
              attribution = '<a href="http://www.juntadeandalucia.es/institutodeestadisticaycartografia" target="_blank">Instituto de Estadística y Cartografía de Andalucía</a>',
              group = 'topo2007') %>% 

  addProviderTiles("Esri.WorldImagery", group='Satellite') %>%
  # Layers control
  addLayersControl(position = 'bottomright',
                   baseGroups = c("Americano 1956",
                                  "OLISTAT (1997-1998)",
                                  "Vuelo Interministerial (1973-1986)",
                                  "Vuelo Nacional (1981-1986)",
                                  "Satellite", "Basemap","Hillshade","Topographical",  "topo2013", "topo2007"),
                   overlayGroups = c('Abandonment Croplands',
                                     'Vegetation transects',
                                     'Quercus pyrenaica forests'),
                   options = layersControlOptions(collapsed = TRUE)) %>%
  addPolygons(data = qp,
                group= 'Quercus pyrenaica forests',
                fillColor = 'red', fillOpacity = 0, 
                stroke = FALSE) %>% 
  addPolygons(data = crops,
                group= 'Abandonment Croplands',
                fillColor = 'orange', fillOpacity = 0, 
                stroke = TRUE, popup = popup_crops, color = "yellow") %>% 
  addPolygons(data = transectos,
                group= 'Vegetation transects',
                color = ~pal(tipo), fillOpacity = .5, 
                stroke = TRUE, popup = popup_transectos)
```


Robledal de San Juan (northwestern of Sierra Nevada) 
=============================================================================

```{r sjMap}
# Set spatial extension 
sj <- subset(crops, loc == 'SANJUAN') 
myext <- extent(sj)

map_base %>% 
  fitBounds(myext@xmin, myext@ymin, myext@xmax, myext@ymax) 
```


Robledal de Cáñar (southern Sierra Nevada) 
=============================================================================

```{r}
# Set spatial extension 
ca <- subset(crops, loc == 'CANAR') 
myext <- extent(ca)

map_base %>% 
  fitBounds(myext@xmin, myext@ymin, myext@xmax, myext@ymax) 
```


Info
=============================================================================

This repo contains a visualization of the spatial distribution of the vegetation transects carried out within MIGRAME project (*Global Change, Altitudinal Range Shift and Colonization of Degraded Habitats in Mediterranean Mountains*). All vegetation data and more info could be accessed in [Pérez-Luque et al. 2015](https://phytokeys.pensoft.net/article/5482/). 

This repository is licensed as Creative Commons Attribution 4.0 ([CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)). You can find more info [here](/LICENSE). Anyone can use the content of the repository citing as following:

* Pérez-Luque AJ (2020). Spatial visualization of vegetation transects for analyze the colonization pattern of abandonment croplands within Quercus pyrenaica woodlands of Sierra Nevada. ![](https://img.shields.io/badge/version-1.0.0-green.svg).  [![DOI](https://zenodo.org/badge/371296612.svg)](https://zenodo.org/badge/latestdoi/371296612)



